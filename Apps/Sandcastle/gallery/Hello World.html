<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Use Viewer to start building new applications or easily embed Cesium into existing applications.">
    <meta name="cesium-sandcastle-labels" content="Beginner, Showcases">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : '../../../Source',
        waitSeconds : 60
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
</style>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
'use strict';
//Sandcastle_Begin

var viewer = new Cesium.Viewer('cesiumContainer');
viewer.extend(Cesium.viewerCesium3DTilesInspectorMixin);
var inspectorViewModel = viewer.cesium3DTilesInspector.viewModel;

var scene = viewer.scene;
scene.fog.enabled = false;

var annotations = scene.primitives.add(new Cesium.LabelCollection());

var tileset = new Cesium.Cesium3DTileset({
    url: '../../../Specs/Data/Cesium3DTiles/Tilesets/Tileset/'
});
inspectorViewModel.tileset = tileset;
scene.primitives.add(tileset);
tileset.readyPromise.then(function(tileset) {
    var boundingSphere = tileset.boundingSphere;
    viewer.camera.viewBoundingSphere(boundingSphere, new Cesium.HeadingPitchRange(0, -2.0, 0));
    viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);

    var properties = tileset.properties;
    if (Cesium.defined(properties) && Cesium.defined(properties.Height)) {
        tileset.style = new Cesium.Cesium3DTileStyle({
            color: {
                conditions: [
                    ["${Height} >= 83", "color('purple')"],
                    ["${Height} >= 80", "color('red')"],
                    ["${Height} >= 70", "color('orange')"],
                    ["${Height} >= 12", "color('yellow')"],
                    ["${Height} >= 7", "color('lime')"],
                    ["${Height} >= 1", "color('cyan')"],
                    ["true", "color('blue')"]
                ]
            },
            meta: {
                description: "'Building id ${id} has height ${Height}.'"
            }
        });
    }

    var boundingVolume = tileset.boundingVolume;
    var rect = boundingVolume.rectangle;
    var height = 30.0;
    var cartographicPositions = [new Cesium.Cartographic(rect.west, rect.south, height),
                                 new Cesium.Cartographic(rect.east, rect.south, height),
                                 new Cesium.Cartographic(rect.east, rect.north, height),
                                 new Cesium.Cartographic(rect.west, rect.north, height),
                                 new Cesium.Cartographic(rect.west, rect.south, height)];
    var cartesianPositions = Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(cartographicPositions);
    viewer.entities.add({
        polyline : {
            positions : cartesianPositions,
            width : 8,
            followSurface : false,
            material : new Cesium.PolylineOutlineMaterialProperty({
                color : Cesium.Color.CYAN,
                outlineWidth : 4,
                outlineColor : Cesium.Color.BLACK
            }),
            depthFailMaterial : Cesium.Color.BLUE
        }
    });
});

var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);

handler.setInputAction(function(movement) {
    var feature = inspectorViewModel.feature;
    if (Cesium.defined(feature)) {
        var properties = feature.primitive.properties; // get properties from tileset
        if (Cesium.defined(properties)) {
            for (var name in properties) {
                if (properties.hasOwnProperty(name)) {
                    console.log(name + ': ' + feature.getProperty(name));
                }
            }
        }

        // evaluate feature description
        if (Cesium.defined(tileset.style)) {
            if (Cesium.defined(tileset.style.meta.description)) {
                console.log('Description : ' + tileset.style.meta.description.evaluate(scene.frameState, feature));
            }
        }
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

handler.setInputAction(function(movement) {
    annotate(movement);
}, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

//When a feature is double middle clicked, hide it
handler.setInputAction(function(movement) {
    var feature = inspectorViewModel.feature;
    if (Cesium.defined(feature)) {
        feature.show = false;
    }
}, Cesium.ScreenSpaceEventType.MIDDLE_CLICK);

function annotate(movement) {
    if (Cesium.defined(inspectorViewModel.feature) && scene.pickPositionSupported) {
        var cartesian = scene.pickPosition(movement.position);
        var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
        var height = cartographic.height.toFixed(2) + ' m';

        annotations.add({
            position : cartesian,
            text : height,
            horizontalOrigin : Cesium.HorizontalOrigin.LEFT,
            verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
            disableDepthTestDistance : Number.POSITIVE_INFINITY
        });
    }
}

//Sandcastle_End
Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
startup(Cesium);
} else if (typeof require === "function") {
require(["Cesium"], startup);
}
</script>
</body>
</html>
